---
title: "Taller_3"
author: "John Esteban"
date: "2024-04-27"
output: html_document
bibliography: bibliografia.bib
---

# Entorno

```{r}
library(tidyverse)
library(gridExtra)
library(knitr)
library(sf)
library(leaflet)
library(leaflet.extras)
library(tmap)
library(tmaptools)
library(reshape2)
```

```{r}
train <- read.csv('train_join2.csv')
test <-  read.csv('test_join2.csv')
shp_data <- st_read("Bogota/Loca.shp")
robos <- read.csv('seguridad.csv')
hospital <- read.csv('Distancia_hospital_train.csv')
train <- cbind.data.frame(train,robos,hospital)

```

```{r}
train_sf <- st_as_sf(train, coords = c("Lon", "Lat"), crs = 4326)
```

# Introduccion

La inversión más importante para la mayoría de las personas es tener casa propia, y esta es una de las fuentes más comunes en la acumulación de capital. Por esto, conocer cuáles son los elementos que determinan el valor de este bien puede servir de guía para el proceso de planificación financiera.

Para la determinación de los precios de las viviendas, en la literatura se han logrado avances significativos. Primero, en relación a las variables, donde los principales trabajos se han concentrado en utilizar las características propias del hogar, con menor impacto de las características externas al hogar aparte del lugar donde están ubicadas. Luego, en relación a los modelos utilizados, se usan los principales algoritmos como regresión lineal, que ayuda en la interpretación, pero también todos los algoritmos basados en árboles de decisión.

Para la selección de variables, se han tomado varias alternativas clasificadas en 3 grupos: características propias del hogar y características del entorno donde está ubicado el hogar. Las más importantes o que más aportan para determinar el precio de la vivienda son: el número de habitaciones, el área del hogar, planta, cantidad de baños, si tiene garaje, edad de la propiedad, área construida, aire acondicionado y el estrato de la vivienda. Los trabajos llegan a la conclusión de que las mejores variables para explicar el precio son: número de habitaciones y de baños, junto con área construida y el estrato.

El segundo grupo de variables está relacionado con las características del entorno donde está ubicada la vivienda. Se utilizan variables como la distancia a estaciones de transporte y de educación, proporción de personas de bajos recursos que viven cerca, porcentaje de centros de negocio y la localización. La distancia al transporte es la característica que más peso tiene.

El modelo que mejor rendimiento ha presentado para la predicción de los precios es el Random Forest. El trabajo desarrollado por @Cueto2022, utilizando solo características de la vivienda en 5 modelos, entre ellos redes neuronales y modelos basados en árboles, encuentra que el que tiene mejor rendimiento es el random forest. De la misma forma, el trabajo de @Choy2023, en donde, además de las características, se utiliza la variable de la distancia al transporte, encuentra que el mejor modelo es el random forest. @Navarro2020, @Alzate2019 y @Angie también encuentran que el random forest es el mejor modelo.

Sin embargo, hay otros algoritmos que también han tenido buen desempeño para predecir el precio de las viviendas. En el trabajo de @Mohamed2023, se destaca el uso de redes neuronales. @Bushan2010 sugiere trabajar con XGBoost, mientras que el modelo Ripper mostró un rendimiento destacado en el trabajo de @Park2015. Además, tanto el gradient boosting como el random forest demostraron eficacia en el estudio de @Alzate2019.

El propósito de este artículo es realizar la predicción de precios de vivienda en Bogotá. En este proceso, se utilizan variables propias de la vivienda, pero en la misma medida, variables que describan el entorno donde está ubicada la vivienda, y también se hace uso extensivo de las técnicas de procesamiento de lenguaje que permiten aprovechar las descripciones de la vivienda.

# Data

## Agregacion de las nuevas variables

Para modelar el precio de las viviendas en Bogotá, se cuenta con diversas características propias del hogar. En primer lugar, tenemos el precio de la vivienda, que es la variable que se va a modelar. Luego, disponemos de algunos atributos esenciales para iniciar el proceso de modelación, tales como el área de la vivienda, el número de habitaciones para dormir y el número de baños. También se puede caracterizar el tipo de vivienda, diferenciando si es una casa o un apartamento. Además, se tiene a disposición la descripción de la vivienda, de donde se pueden extraer datos que ayuden a describir mejor la propiedad.

Para conocer mejor el contexto en el que se ubica la vivienda, se creó la variable "estrato" a partir de la información del DANE. En primer lugar, se descargó la cartografía del Marco Geoestadístico Nacional del DANE y el Censo 2018 a nivel de manzana. Luego, se hizo un join espacial entre cada uno de los inmuebles y el Marco Geoestadístico Nacional para identificar la manzana de cada una de las viviendas. Posteriormente, con el código de manzana, se realizó un join con el Censo 2018 para identificar el estrato predominante.

La percepción de seguridad también es un aspecto clave para determinar la disposición a pagar por una vivienda. Se espera que, si hay mayor seguridad, el precio de la vivienda sea mayor. Para medir este fenómeno, se incluyeron una serie de variables relevantes. Con las cifras oficiales de la alcaldía, se obtuvo información geolocalizada de hurtos a personas y viviendas. Esta información solo está disponible a nivel de localidades y no georreferenciada de manera similar a la base de datos. Por ello, se utilizó la distancia para integrar la información de hurtos más cercanos. Además, a través de la información de Google, se calculó la distancia entre las viviendas y las estaciones de policía.

## Analisis descriptivo de los datos

### Precio

El objetivo de este artículo es predecir el precio de las viviendas en la ciudad de Bogotá. Esta variable está medida a lo largo de tres años distintos, lo que en términos reales no representa lo mismo. Por esta razón, el primer paso fue realizar una deflactación de estas variables a términos reales, de modo que esto no afectara el proceso de modelación.

Teniendo esto en cuenta, se observa que el precio de entrada para comprar una vivienda en Bogotá, tomando como referencia esta base de datos, es de 300 millones de pesos, con un máximo de 1650 millones y un precio promedio de aproximadamente 650 millones. En términos de precios de vivienda, Bogotá se encuentra por debajo del promedio nacional. Según el Índice de Precios de Vivienda del DANE, el índice de precios en Bogotá es de 126 puntos, mientras que el promedio nacional es de 130 puntos. Además, el aumento de precios durante estos tres años ha sido moderado, con un incremento promedio del 8%.

```{r}
train %>%
  count(year)
```

```{r}
format(summary(train$price),scientific=FALSE)
```

### Caracteristicas del hogar

En primer lugar vamos a analizar como se relacionan las principales variables del hogar frente al precio de venta que tiene disponible, para este analisis se toman el numero de habitaciones, numero de banos, numero de alcobas, tipo de propiedad, estrato y el piso donde se encuentra ubicado. En primer lugar vamos a imputar de forma sencilla las variables que tienen N'A y luego procedemos con un analisis descriptivo bivariado.

```{r}
train <-train %>%
  filter(rooms <5, bathrooms<5,bedrooms<5,nbanios<5,nhabitaciones<5,piso_apartamento<5)

vars <- train %>% 
  select(rooms, bedrooms, bathrooms, property_type, estrato_predominante, nbanios, nhabitaciones, piso_apartamento,price) %>%
  mutate(log_price = log(price))



# Imputar los valores NA con la media redondeada de cada columna numérica
vars_imputed <- vars %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), round(mean(., na.rm = TRUE)), .)))

vars_imputed <- vars_imputed %>%
  mutate(across(-log_price, as.factor))



# Función para generar gráficos de barras de conteo
generate_barplot <- function(data, x_var) {
  ggplot(data, aes_string(x = x_var)) +
    geom_bar(fill = "steelblue") +
    labs(title = paste("Count of", x_var),
         x = x_var, 
         y = "Count") +
    theme_minimal()
}

# Lista de variables cualitativas
variables <- c("rooms", "bedrooms", "bathrooms", "property_type", 
               "estrato_predominante", "nbanios", "nhabitaciones", "piso_apartamento")

# Generar gráficos de barras y guardarlos en una lista
bar_plots <- lapply(variables, function(var) generate_barplot(vars_imputed, var))

# Crear una grilla de gráficos
do.call("grid.arrange", c(bar_plots, ncol = 2))
```

La cantidad de habitaciones mas comun que tienen las viviendas que estan puestas en venta son 3 , lo mismo que para el numero de habitaciones para dormir, para el caso de los baños en este proceso la cantidad es igual, esto se explicar debido a que la mayoria de tipos de vivienda son apartamentos. La cantidad de numero de baños es muy similar pero en este caso se concentran mucho mas en 2 y 3 habitaciones. Un punto interesante es que en la muestra de datos que tenemos disposición la mayoria son apartamentos que estan ubicandos en zonas de Estrato 4, 5 y 6.

```{r}


# Crear una función para generar los boxplots
generate_boxplot <- function(data, x_var, y_var = "log_price") {
  ggplot(data, aes_string(x = x_var, y = y_var)) +
    geom_boxplot() +
    labs(title = paste("Boxplot of", x_var, "vs", y_var),
         x = x_var, 
         y = y_var) +
    theme_minimal()
}

# Lista de variables cualitativas (excluyendo 'price' y 'log_price')
variables <- c("rooms", "bedrooms", "bathrooms", "property_type", 
               "estrato_predominante", "nbanios", "nhabitaciones", "piso_apartamento")

# Generar los boxplots y guardarlos en una lista
plots <- lapply(variables, function(var) generate_boxplot(vars_imputed, var))

# Crear una grilla de gráficos
do.call("grid.arrange", c(plots, ncol = 2))
```

Cuando se analiza la relacion que existen entre las caracterisitcas de las viviendas con el logaritmo del precio de las viviendas se encuentra que existen relaciones estadisticias con el numero de balis, de habitaciones, con el tipo de la vivienda y el estrato socioeconomico.

Estos resultados son consistentes con los hallazgos que se ven en la literatura en donde mas habitaciones tenga una vivienda su precio tiende a aumentar y el mismo caso tambien para la cantidad de baños. Para esta muestra se tiene que el tipo de vivienda mas costoso son las casas , pero entendiendo que se tienen muy pocos registros para este tipo de vivienda. POr ultimo se nota que conforme aumenta el estrato el promedio de precio de la vivienda comienza a aumentar, desde el estrato 4 al 6, que es donde mas datos disponibles se tienen.

```{r}

train_coords <- train_sf %>%
  st_coordinates() %>%
  as.data.frame() %>%
  rename(Lon = X, Lat = Y) %>%
  bind_cols(train)

# Calcular los valores de log(price) para la leyenda
train_coords$log_price <- log(train_coords$price)

# Inicializar el mapa centrado en Bogotá
mapa <- leaflet() %>%
  addTiles() %>%
  setView(lng = -74.08175, lat = 4.60971, zoom = 12) %>%
  addPolygons(data = shp_data, color = "blue", weight = 2, opacity = 0.5) %>%
  addHeatmap(lng = ~Lon...41, lat = ~Lat...42, intensity = ~log_price, blur = 20, max = 0.05, radius = 15, data = train_coords) %>%
  addControl("<img src='https://leafletjs.com/examples/custom-icons/leaf-red.png' style='width:24px;height:24px;'>", position = "topright", className = "compass")

mapa
```

Este mapa muestra la concetración de las viviendas que estan siendo analizadas en este estudio. En primer lugar, la mayoria de las viviendas que esna en venta se encuentran en al oeste , norte y sur de la ciudad. Como se nota en el mapa de calor, donde se coloca el logartimo de precios de la vivienda como entre las viviendas se encuentres mas cerca de la periferia de la ciudad la intensidad del precio es mayor.Lo que evidencia que la ubicación es importante para la predicción de precios.

### Seguridad y salud

Se espera que entre mas seguro sea el lugar donde este ubicada la vivienda el costo sea mayor. Para explorar esta variable se trabaja desde dos enfoques, en primer lugar se toma la informacionde la alcaldia de bogota sobre la cantidad de robos a personas y a casas georeferenciadas a nivel de localidad y luego por medio de la distancia se agrega la cantidad de robos que mas cerca se presentan. Luego vamos a trabajar con la distancia minima que se encuentra entre el hogar con una estacion de policia, se espera que entre mas cerca se encuentre una vivienda de una estacion de policia entonces la percepcion de seguridad sea mayor y el precio de la vivienda aumente.

```{r}
train <- train %>% mutate(price_l = log(price))
cor_matrix <- cor(train %>% select(price, Robos_vivienda, Robos_personas,distancia_estacion_policia,distancia_hospital)) 

# Convertir la matriz de correlación a un formato largo adecuado para ggplot2
melted_cor_matrix <- melt(cor_matrix)

# Crear el gráfico de calor
ggplot(data = melted_cor_matrix, aes(x=Var1, y=Var2, fill=value)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Correlación") +
  geom_text(aes(label = round(value, 2)), color = "black", size = 4) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1)) +
  theme_minimal() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, 
                                   size = 12, hjust = 1)) +
  coord_fixed()
```

Con esta gráfica, podemos observar que existe una relación negativa entre el valor de una vivienda y la cantidad de robos cercanos que se han producido. Esto indica que la percepción de seguridad es un factor a tener en cuenta al momento de entender el valor de la vivienda. Del mismo modo, cuanto mayor sea la distancia entre la vivienda y la estación de policía, el precio de la vivienda tiende a bajar. Por lo tanto, se puede comprobar la hipótesis de que la percepción de seguridad es importante para entender el precio de la vivienda. Del mismo modo existe una relacion negativa entre el precio de la vivienda y la distancia a los centros de salud, como se explicaba en la revision de literatura este tipo de variables tienen impacto significativo sobre el precio de la vivienda.

# Modelos y resultados.

# Conclusiones
