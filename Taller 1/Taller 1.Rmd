---
title: "Taller 1"
output:
  word_document: default
  html_document:
    citation_package: natbib
date: "2024-02-07"
bibliography: bibliografia.bib
editor_options: 
  markdown: 
    wrap: 72
---

```{r echo=FALSE}
library(gridExtra)
t1<-Sys.time()
library(rvest)
library(tidyverse)
```



La estrategia propuesta para conservar la representatividad de la
muestra que permite el factor de expansión consiste en transformar esta
variable en un factor de ponderación de manera que conservemos su
proporción con respecto al universo sin afectar el tamaño original de la
muestra, de esta manera se ahorra recursos computacionales la ejecución
de los algoritmos y el tratamiento de los datos.

```{r}
base_no_ponderada<-length(data$fex_c)
universo_representado<-sum(data$fex_c)

data<-  data %>%
  mutate(data, peso=fex_c/universo_representado) %>% 
  mutate(data,fponderacion=peso*base_no_ponderada)

base_ponderada<-sum(data$fponderacion)
unidades_muestrales_fex<-length(unique(data$fex_c))
unidades_muestrales_fpon<-length(unique(data$fponderacion))

tabla1<-t(tibble(base_no_ponderada,base_ponderada,unidades_muestrales_fex,unidades_muestrales_fpon,universo_representado))
tabla1
```

Para trabajar con los datos ponderados se replica cada registro tantas
unidades muestrales represente.

```{r}
data_ponderada<-uncount(data,weights = round(data$fponderacion))
base_ponderada<-length(data_ponderada$directorio)
base_ponderada
base_no_ponderada
```

# Introduccion

El objetivo de este informe es encontrar los determinantes del salario
de las personas encuestadas en Bogotá y realizar una predicción del
mismo. Encontrar los determinantes del salario es importante porque
proporciona una guía tanto en términos personales como de política
económica cuando se busca aumentar los ingresos de las personas. Desde
la perspectiva de la política económica, aumentar los ingresos reales de
las personas puede contribuir al mejoramiento de su calidad de vida. Por
lo tanto, si se conocen los factores que pueden aumentar su capacidad
adquisitiva, es importante desarrollar políticas públicas orientadas en
ese sentido. Por otro lado, el estudio de los determinantes del salario
también es útil para las personas que ya tienen un empleo y aspiran a
mejorar sus condiciones de vida. Si se encuentra, por ejemplo, que la
educación es clave, es en este ámbito donde el trabajador debe centrar
sus esfuerzos para mejorar.

Desde la teoría económica, la ecuación de Mincer es un punto de partida
para estudiar los determinantes del salario laboral. Este modelo estima
el impacto de un año adicional de estudios en las rentas laborales de
los individuos (Mincer, 1974). La ecuación tradicional de Mincer se
puede estimar mediante mínimos cuadrados ordinarios (MCO), utilizando
como variable dependiente los ingresos y como variables independientes
los años de educación, la experiencia laboral y el cuadrado de esta
última.

$$ln(w) = \beta_{0} + \beta_{1}S + \beta_{2}Exp + \beta_{3}Exp^2 + \epsilon$$
Donde: - $w$ son los ingresos del individuo. - $S$ es el número de años
de educación formal completada. - $\text{Exp}$ son los años de
experiencia laboral. - $\epsilon$ es el término de perturbación
aleatoria que se distribuye según una Normal
$\mathcal{N}(0, \sigma_{\epsilon}^2)$.

Para este estudio, se utilizará información de la Gran Encuesta
Integrada de Hogares (GEIH). Esta encuesta solicita información sobre
las condiciones de empleo de las personas y las características
generales de la población. Por lo tanto, tenemos los insumos necesarios
para encontrar los determinantes del salario.

Con base en lo anterior, podemos iniciar el análisis de las siguientes
variables:

-   Edad (Age)
-   Cuenta propia (Self-employed)
-   Estrato (Socioeconomic stratum)
-   Formal (Formal employment)
-   Horas trabajadas la semana pasada (Actualhours worked previous week)
-   Horas trabajadas habitualmente (Usual weeklyhours worked)
-   Informal (Informal employment)
-   Ingreso total (Totalincome)
-   Educación (Max. Education level attained)
-   Oficio (Occupation)
-   Experiencia (Experience)
-   Salario (Salary)
-   Sexo (Sex)
-   Horas trabajadas(Total hours worked)
-   Tamaño de la empresa (Company size)

# Datos


## Lectura de los datos

El proceso para leer los datos consiste en hacer un web scrapping a la informacion que se encuentra en esta pagina web: https://ignaciomsarmiento.github.io/GEIH2018 sample/. Los datos estan particionado en 10 paginas diferentes por lo cual se tenia que hacer un proceso iterativo.  En primer lugar se guarda en la variable url_base la direccion web de la que se debe extraer la infomracion. Hay un ligero cambio respecto a la url general y este es que las tablas se encuentran un poco mas anidades por lo que se debe completar la url. 

Como la base de datos completa se encuentra separada en 10 partes el proceso se debe repetir el mismo numero de veces. Primero se crea una lista vacia llamada tables_list, en esta lista se guarda la inofmracion extraida de la pagina en  cada iteracion.  Dentro del bucle for se va modificando la ruta de extraccion para que haga un recorrido por todas las direcciones donde se encuentran los datos, esto es relativamente sencillo debido a que lo unico que cambioa es el numero de la pagina por esto el iterador es un entero.

Cuando se haga el proceso iterativo en las 10 paginas estas quedan anidadas en la lista vacia tables_list, para darle un formato manejable en el proceso de machine learning se concatenan en una sola sabana de datos con formato tibble. Como la cantidad de datos es considerable este proceso dura aproximadamente 8 minutos.

```{r}
url_base<-my_url <- "https://ignaciomsarmiento.github.io/GEIH2018_sample/pages/geih_page_"

tables_list <- list()
for (i in 1:10){
 bucle_url<-paste0(url_base, i, ".html")
 my_html=read_html(bucle_url)
 table<-my_html %>% html_table()
 tables_list[[i]] <- table}

data<-dplyr::bind_rows(tables_list)
t2<-Sys.time()
Tiempo_ejecucion<-t2-t1
Tiempo_ejecucion
```
## Preprocesamiento de datos

El preprocesamiento de los datos se realiza de forma simultanea con el analisis descriptivo . Esto se da porque generalmente cuando se analiza la distribucion de cada variable de forma invidual es que se logra identificar registros vacios o atipicos que merecen un tratamiento aparte. Sin embargo, aplicamos unas reglas de validacion iniciar para garantizar que los modelos de regresion tengan resultados satisfactorios. 

Primero se cambiaron los nombres de las variables que se van usar para que su identificacoin fuera mas sencilla, tambien se les dio el formato adecuado de tal forma que se respetara la naturaleza cualitativa o cuantitativa de las mismas. Los filtros mas importantes de la base de datos fueron para la poblacion en edad de trabajar, como sugerencia del ejercicio solo hay registros para personas mayores de edad. Tambien se filtran las personas que estan activas en el mercado de trabajo ya que son estas las unicas que perciben un salario.

```{r}
# Limpieza de mayores de edad: Este chunk lo usamos solo como limpieza de datos 


## Falta filtrar solo por personas 
data <- data %>%
    rename(
      Edad= age,
      Estrato=estrato1,
      Ingreso=ingtot,
      Educacion=p6210,
      Experiencia= p6426,
      Salario=p6500,
      Sexo=sex,
      Horas_trabajadas=totalHoursWorked
  )  %>%
  
    mutate(
      across(c(cuentaPropia,Estrato,formal,informal,maxEducLevel,oficio,Educacion,Sexo),as.character) 
  )

### Filtro por población economica activa

data <- data %>%
  filter(Edad >18 & dsi !="1") 


data <-data %>%
  filter(p6240==1)

```
## Analisis exploratorio de datos indiviudal

Para que la manipulacion de los datos sea mas sencilla se toma del dataframe original solo las columnas que se establecieron en la introduccion y se guardan en el dataframe datah.

```{r}
data_h <- data %>%
  select(Edad,cuentaPropia,Estrato,formal,informal,Ingreso,maxEducLevel,oficio,Educacion,Experiencia,Salario,Sexo,Horas_trabajadas)
```
Luego para visualizar la distribucion invidual de las variables con mas precision se dividen en dos grupos tomando como referencia su naturaleza, es decir si son cualitativas o cuantitativas.

```{r}
data_h$Estrato <- factor(data_h$Estrato, levels = c("1", "2", "3", "4", "5"))

character_cols <- data_h %>%
  select(where(is.character))


calculate_percentage <- function(column) {
  prop.table(table(column)) * 100
}


percentage_distributions <- map(character_cols, calculate_percentage)

# Crear los gráficos
character_plots <- map2(percentage_distributions, names(percentage_distributions), ~ ggplot(mapping = aes(x = reorder(names(.x), .x), y = .x)) +
                           geom_bar(stat = "identity", fill = "#0073C2FF") +
                           labs(x = "", y = "Percentage", title = paste("Distribution of", .y)) +  
                           theme_minimal() +
                           theme(plot.title = element_text(color = "black", hjust = 0),
                                 axis.text.x = element_text(angle = 45, hjust = 1)))

# Organizar los gráficos en una cuadrícula
character_grid <- grid.arrange(grobs = character_plots, ncol = 2)


```


```{r}
numeric_cols <- data_h %>%
  select(where(is.numeric))

numeric_plots <- map2(numeric_cols, names(numeric_cols), ~ ggplot(data_h, aes(x = .x)) +
                         geom_histogram(fill = "skyblue", color = "black", bins = 10) +
                         ggtitle(paste("Distribucion of", .y)) +  # Set the title to the column name
                         theme_minimal() +
                         theme(plot.title = element_text(color = "black", hjust = 0)))


numeric_grid <- grid.arrange(grobs = numeric_plots, ncol = 2)
```




## Analisis exploratorio bivariado


## AEDE individual

En este apartado observamos como se comportan las variables incluidas en
el modelo , con el objetivo de analizar su distribucion e iniciar con el
proceso de limpieza








# Analisis de regresion

EL proposito es estimar el siguiente modelo:

$$log(w) = \beta_{1} + \beta_{2}Edad + \beta_{3}Edad^2$$

# Modelo de genero

$$log(w) = \beta_{1} + \beta_{2}Mujer$$

# 5 Prediccion

El dia de hoy estime

# Bibliografía
